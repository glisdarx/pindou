<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>像素图转换器 - Mard色号版</title>
    <style>
        /* CSS 样式部分保持不变，这里省略以保持整洁 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1.2fr; gap: 24px; height: calc(100vh - 40px); }
        .panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 24px; padding: 32px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .upload-panel { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .title { font-size: 32px; font-weight: 700; color: #1d1d1f; text-align: center; margin-bottom: 8px; }
        .subtitle { font-size: 18px; color: #86868b; text-align: center; margin-bottom: 32px; }
        .upload-area { width: 100%; max-width: 400px; height: 250px; border: 3px dashed #d1d1d6; border-radius: 16px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .upload-area:hover { border-color: #007aff; background: rgba(0, 122, 255, 0.05); transform: translateY(-4px); }
        .upload-area.drag-over { border-color: #007aff; background: rgba(0, 122, 255, 0.1); transform: scale(1.02); }
        .upload-icon { width: 64px; height: 64px; background: #007aff; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; transition: transform 0.3s ease; }
        .upload-area:hover .upload-icon { transform: scale(1.1); }
        .upload-text { font-size: 20px; font-weight: 600; color: #1d1d1f; margin-bottom: 8px; }
        .upload-hint { font-size: 16px; color: #86868b; text-align: center; }
        .preview-image { width: 100%; height: 100%; object-fit: contain; border-radius: 13px; }
        .controls { display: flex; flex-direction: column; gap: 20px; margin-top: 24px; }
        .control-group { display: flex; flex-direction: column; gap: 12px; }
        .control-label { font-size: 18px; font-weight: 600; color: #1d1d1f; }
        .options-set { display: flex; gap: 12px; }
        .option-btn { flex: 1; padding: 16px; border: 2px solid #e5e5e7; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: white; }
        .option-btn:hover { border-color: #007aff; transform: translateY(-2px); }
        .option-btn.active { border-color: #007aff; background: #007aff; color: white; }
        .option-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .option-desc { font-size: 14px; opacity: 0.8; }
        .convert-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #007aff, #5856d6); color: white; border: none; border-radius: 16px; font-size: 18px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3); }
        .convert-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0, 122, 255, 0.4); }
        .convert-btn:disabled { background: #e5e5e7; color: #86868b; cursor: not-allowed; transform: none; box-shadow: none; }
        .result-panel { display: flex; flex-direction: column; overflow: hidden; }
        .result-title { font-size: 24px; font-weight: 700; color: #1d1d1f; margin-bottom: 20px; text-align: center; }
        .canvas-container { flex: 1; display: flex; align-items: center; justify-content: center; min-height: 300px; position: relative; }
        #pixelCanvas { max-width: 100%; max-height: 100%; border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); background: white; cursor: crosshair; }
        .color-tooltip { position: absolute; background: rgba(0, 0, 0, 0.9); color: white; padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; pointer-events: none; transform: translate(-50%, -100%); margin-top: -8px; white-space: nowrap; z-index: 1000; opacity: 0; transition: opacity 0.2s ease; }
        .color-tooltip.show { opacity: 1; }
        .color-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 4px solid transparent; border-top-color: rgba(0, 0, 0, 0.9); }
        .color-palette { margin-top: 20px; max-height: 150px; overflow-y: auto; }
        .palette-title { font-size: 18px; font-weight: 600; color: #1d1d1f; margin-bottom: 12px; }
        .color-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .color-item { display: flex; flex-direction: column; align-items: center; padding: 8px; border-radius: 8px; transition: all 0.3s ease; cursor: pointer; border: 2px solid transparent; }
        .color-item:hover { background: rgba(0, 122, 255, 0.1); border-color: #007aff; }
        .color-item.highlighted { background: rgba(0, 122, 255, 0.2); border-color: #007aff; transform: scale(1.05); }
        .color-item.dimmed { opacity: 0.3; }
        .color-swatch { width: 32px; height: 32px; border-radius: 6px; margin-bottom: 4px; border: 1px solid rgba(0, 0, 0, 0.1); }
        .color-code { font-size: 12px; font-weight: 600; color: #1d1d1f; }
        .action-buttons { margin-top: auto; padding-top: 16px; display: flex; gap: 12px; }
        .action-btn { flex-grow: 1; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .download-btn { background: #34c759; color: white; box-shadow: 0 4px 16px rgba(52, 199, 89, 0.3); }
        .download-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(52, 199, 89, 0.4); }
        .zoom-btn { background: #5856d6; color: white; box-shadow: 0 4px 16px rgba(88, 86, 214, 0.3); }
        .zoom-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(88, 86, 214, 0.4); }
        .hidden { display: none !important; }
        .canvas-wrapper { position: relative; display: flex; align-items: center; justify-content: center; }
        #highlightCanvas { position: absolute; top: 0; left: 0; pointer-events: none; border-radius: 16px; }
        .zoom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .zoom-modal img { max-width: 90vw; max-height: 90vh; object-fit: contain; cursor: default; image-rendering: -moz-crisp-edges; image-rendering: pixelated; }
        .zoom-modal .close-btn { position: absolute; top: 20px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .zoom-modal .close-btn:hover, .zoom-modal .close-btn:focus { color: #bbb; text-decoration: none; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; gap: 16px; height: auto; } .panel { padding: 24px; } .title { font-size: 28px; } .upload-area { height: 200px; } .options-set { flex-direction: column; } .controls { margin-top: 20px; } .color-list { grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); } .action-buttons { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel upload-panel">
            <h1 class="title">像素图转换器</h1>
            <p class="subtitle">将任何图片转换为Mard色号像素风格</p>
            <div class="upload-area" id="uploadArea"><div class="upload-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 18V16H17V18H7ZM12 14.5L7.5 10L9.25 8.25L11 10V2H13V10L14.75 8.25L16.5 10L12 14.5Z" fill="white"/></svg></div><div class="upload-text">拖拽图片到这里</div><div class="upload-hint">或点击选择图片文件<br>支持 JPG、PNG、GIF 格式</div></div>
            <div class="controls">
                <div class="control-group"><label class="control-label">像素密度</label><div class="options-set" id="pixelOptions"><div class="option-btn active" data-value="20"><div class="option-title">20×20</div><div class="option-desc">粗糙风格</div></div><div class="option-btn" data-value="50"><div class="option-title">50×50</div><div class="option-desc">平衡风格</div></div><div class="option-btn" data-value="100"><div class="option-title">100×100</div><div class="option-desc">精细风格</div></div></div></div>
                <div class="control-group"><label class="control-label">颜色数量</label><div class="options-set" id="colorOptions"><div class="option-btn active" data-value="10"><div class="option-title">最多10色</div><div class="option-desc">极简</div></div><div class="option-btn" data-value="16"><div class="option-title">最多16色</div><div class="option-desc">经典</div></div><div class="option-btn" data-value="24"><div class="option-title">最多24色</div><div class="option-desc">丰富</div></div></div></div>
                <button class="convert-btn" id="convertBtn" disabled>上传图片开始转换</button>
            </div>
            <input type="file" id="fileInput" accept="image/*" class="hidden">
        </div>
        <div class="panel result-panel">
            <h2 class="result-title">预览结果</h2>
            <div class="canvas-container"><div class="canvas-wrapper"><canvas id="pixelCanvas" class="hidden"></canvas><canvas id="highlightCanvas" class="hidden"></canvas></div><div class="color-tooltip" id="colorTooltip"></div><div id="placeholder" style="color: #86868b; font-size: 18px; text-align: center;">转换后的像素图将在这里显示<br><small style="font-size: 14px; margin-top: 8px; display: block;">悬停在像素块上查看Mard色号</small></div></div>
            <div class="color-palette hidden" id="colorPalette"><div class="palette-title">使用的Mard色号</div><div class="color-list" id="colorList"></div></div>
            <div class="action-buttons hidden" id="actionButtons"><button class="action-btn zoom-btn" id="zoomBtn">放大查看</button><button class="action-btn download-btn" id="downloadBtn">下载像素图</button></div>
        </div>
    </div>
    <div id="zoomModal" class="zoom-modal hidden"><span class="close-btn" id="closeZoomBtn">×</span><img id="zoomedImage" alt="Zoomed Pixel Art"></div>
    <script>
        // ... Mard色号数据保持完整，此处省略 ...
        const mardColors = [ { "Mard色号": "H0", "映射颜色": "#000000" }, { "Mard色号": "A1", "映射颜色": "#FBF5D0" }, { "Mard色号": "A2", "映射颜色": "#F9F3C1" }, { "Mard色号": "A3", "映射颜色": "#F8EEAE" }, { "Mard色号": "A4", "映射颜色": "#F6E999" }, { "Mard色号": "A5", "映射颜色": "#F5E586" }, { "Mard色号": "A6", "映射颜色": "#F4E175" }, { "Mard色号": "A7", "映射颜色": "#F8DAB2" }, { "Mard色号": "A8", "映射颜色": "#F7D39D" }, { "Mard色号": "A9", "映射颜色": "#F6CE88" }, { "Mard色号": "A10", "映射颜色": "#F4C773" }, { "Mard色号": "A11", "映射颜色": "#F2C15F" }, { "Mard色号": "A12", "映射颜色": "#F1BA4A" }, { "Mard色号": "A13", "映射颜色": "#F4BCB8" }, { "Mard色号": "A14", "映射颜色": "#F2ADA9" }, { "Mard色号": "A15", "映射颜色": "#EE9D99" }, { "Mard色号": "A16", "映射颜色": "#ECAE9F" }, { "Mard色号": "A17", "映射颜色": "#E9A18D" }, { "Mard色号": "A18", "映射颜色": "#E7947B" }, { "Mard色号": "A19", "映射颜色": "#EED2C9" }, { "Mard色号": "A20", "映射颜色": "#EBC9B9" }, { "Mard色号": "A21", "映射颜色": "#E8C0A9" }, { "Mard色号": "A22", "映射颜色": "#E5B799" }, { "Mard色号": "A23", "映射颜色": "#E2AE8A" }, { "Mard色号": "A24", "映射颜色": "#DFA57A" }, { "Mard色号": "A25", "映射颜色": "#D9E8A2" }, { "Mard色号": "A26", "映射颜色": "#CFE286" }, { "Mard色号": "B1", "映射颜色": "#A4D26C" }, { "Mard色号": "B2", "映射颜色": "#8BCB69" }, { "Mard色号": "B3", "映射颜色": "#71C366" }, { "Mard色号": "B4", "映射颜色": "#58BD64" }, { "Mard色号": "B5", "映射颜色": "#55B55A" }, { "Mard色号": "B6", "映射颜色": "#25AC58" }, { "Mard色号": "B7", "映射颜色": "#00A356" }, { "Mard色号": "B8", "映射颜色": "#009953" }, { "Mard色号": "B9", "映射颜色": "#008F50" }, { "Mard色号": "B10", "映射颜色": "#00864E" }, { "Mard色号": "B11", "映射颜色": "#97C5A3" }, { "Mard色号": "B12", "映射颜色": "#7EB991" }, { "Mard色号": "B13", "映射颜色": "#65AC7F" }, { "Mard色号": "B14", "映射颜色": "#4CA06E" }, { "Mard色号": "B15", "映射颜色": "#33935C" }, { "Mard色号": "B16", "映射颜色": "#1A874A" }, { "Mard色号": "B17", "映射颜色": "#6BB0A1" }, { "Mard色号": "B18", "映射颜色": "#47A592" }, { "Mard色号": "B19", "映射颜色": "#249A84" }, { "Mard色号": "B20", "映射颜色": "#008F75" }, { "Mard色号": "B21", "映射颜色": "#008467" }, { "Mard色号": "B22", "映射颜色": "#007A58" }, { "Mard色号": "B23", "映射颜色": "#5A6753" }, { "Mard色号": "B24", "映射颜色": "#6A745C" }, { "Mard色号": "B25", "映射颜色": "#798064" }, { "Mard色号": "B26", "映射颜色": "#898D6D" }, { "Mard色号": "B27", "映射颜色": "#989975" }, { "Mard色号": "B28", "映射颜色": "#A7A67E" }, { "Mard色号": "B29", "映射颜色": "#D3D6A1" }, { "Mard色号": "B30", "映射颜色": "#CED08E" }, { "Mard色号": "B31", "映射颜色": "#C8CB7A" }, { "Mard色号": "B32", "映射颜色": "#C3C567" }, { "Mard色号": "C1", "映射颜色": "#C0C9D9" }, { "Mard色号": "C2", "映射颜色": "#B0BBD1" }, { "Mard色号": "C3", "映射颜色": "#9FB0CA" }, { "Mard色号": "C4", "映射颜色": "#8FA5C2" }, { "Mard色号": "C5", "映射颜色": "#7F9ABB" }, { "Mard色号": "C6", "映射颜色": "#6E8FB4" }, { "Mard色号": "C7", "映射颜色": "#5E84AC" }, { "Mard色号": "C8", "映射颜色": "#4E79A5" }, { "Mard色号": "C9", "映射颜色": "#8DC4D8" }, { "Mard色号": "C10", "映射颜色": "#73BBD2" }, { "Mard色号": "C11", "映射颜色": "#59B1CB" }, { "Mard色号": "C12", "映射颜色": "#3FA8C5" }, { "Mard色号": "C13", "映射颜色": "#249EBE" }, { "Mard色号": "C14", "映射颜色": "#0A95B8" }, { "Mard色号": "C15", "映射颜色": "#83A5BE" }, { "Mard色号": "C16", "映射颜色": "#6994B1" }, { "Mard色号": "C17", "映射颜色": "#5084A5" }, { "Mard色号": "C18", "映射颜色": "#367398" }, { "Mard色号": "C19", "映射颜色": "#1D638C" }, { "Mard色号": "C20", "映射颜色": "#03527F" }, { "Mard色号": "C21", "映射颜色": "#C1C6C5" }, { "Mard色号": "C22", "映射颜色": "#B1B8B7" }, { "Mard色号": "C23", "映射颜色": "#A1AAA9" }, { "Mard色号": "C24", "映射颜色": "#919C9B" }, { "Mard色号": "C25", "映射颜色": "#818D8C" }, { "Mard色号": "C26", "映射颜色": "#717F7E" }, { "Mard色号": "C27", "映射颜色": "#696685" }, { "Mard色号": "C28", "映射颜色": "#777595" }, { "Mard色号": "C29", "映射颜色": "#8583A5" }, { "Mard色号": "D1", "映射颜色": "#A8A3C0" }, { "Mard色号": "D2", "映射颜色": "#9A96B7" }, { "Mard色号": "D3", "映射颜色": "#8B88AE" }, { "Mard色号": "D4", "映射颜色": "#6C5987" }, { "Mard色号": "D5", "映射颜色": "#7F6A9B" }, { "Mard色号": "D6", "映射颜色": "#937BAF" }, { "Mard色号": "D7", "映射颜色": "#A68CC2" }, { "Mard色号": "D8", "映射颜色": "#B99ED6" }, { "Mard色号": "D9", "映射颜色": "#CCA0E9" }, { "Mard色号": "D10", "映射颜色": "#907CA6" }, { "Mard色号": "D11", "映射颜色": "#9D89B1" }, { "Mard色号": "D12", "映射颜色": "#AA97BC" }, { "Mard色号": "D13", "映射颜色": "#B7A5C7" }, { "Mard色号": "D14", "映射颜色": "#C4B2D2" }, { "Mard色号": "D15", "映射颜色": "#D1BFDD" }, { "Mard色号": "D16", "映射颜色": "#64668D" }, { "Mard色号": "D17", "映射颜色": "#706F97" }, { "Mard色号": "D18", "映射颜色": "#7C78A1" }, { "Mard色号": "D19", "映射颜色": "#8881AC" }, { "Mard色号": "D20", "映射颜色": "#948AB6" }, { "Mard色号": "D21", "映射颜色": "#A093C1" }, { "Mard色号": "D22", "映射颜色": "#505581" }, { "Mard色号": "D23", "映射颜色": "#5D608B" }, { "Mard色号": "D24", "映射颜色": "#696C95" }, { "Mard色号": "D25", "映射颜色": "#76779F" }, { "Mard色号": "D26", "映射颜色": "#8383A9" }, { "Mard色号": "E1", "映射颜色": "#F7E0C5" }, { "Mard色号": "E2", "映射颜色": "#F7DAE3" }, { "Mard色号": "E3", "映射颜色": "#F5D0DB" }, { "Mard色号": "E4", "映射颜色": "#F3C6D3" }, { "Mard色号": "E5", "映射颜色": "#F1BCCD" }, { "Mard色号": "E6", "映射颜色": "#EFB2C5" }, { "Mard色号": "E7", "映射颜色": "#EDA8BD" }, { "Mard色号": "E8", "映射颜色": "#F1C5D0" }, { "Mard色号": "E9", "映射颜色": "#EEB9C5" }, { "Mard色号": "E10", "映射颜色": "#ECAEBA" }, { "Mard色号": "E11", "映射颜色": "#E9A3AF" }, { "Mard色号": "E12", "映射颜色": "#E698A4" }, { "Mard色号": "E13", "映射颜色": "#E38D9A" }, { "Mard色号": "E14", "映射颜色": "#EAD1CE" }, { "Mard色号": "E15", "映射颜色": "#E6C5C1" }, { "Mard色号": "E16", "映射颜色": "#E3B9B5" }, { "Mard色号": "E17", "映射颜色": "#E0ADAA" }, { "Mard色号": "E18", "映射颜色": "#DCA19E" }, { "Mard色号": "E19", "映射颜色": "#D99592" }, { "Mard色号": "E20", "映射颜色": "#DBCAC6" }, { "Mard色号": "E21", "映射颜色": "#D4BCB8" }, { "Mard色号": "E22", "映射颜色": "#CDAEA9" }, { "Mard色号": "E23", "映射颜色": "#C6A19B" }, { "Mard色号": "E24", "映射颜色": "#BF938D" }, { "Mard色号": "F1", "映射颜色": "#F5CCC2" }, { "Mard色号": "F2", "映射颜色": "#F2B2A7" }, { "Mard色号": "F3", "映射颜色": "#EF988B" }, { "Mard色号": "F4", "映射颜色": "#EC7E70" }, { "Mard色号": "F5", "映射颜色": "#E96454" }, { "Mard色号": "F6", "映射颜色": "#E64A39" }, { "Mard色号": "F7", "映射颜色": "#E3301D" }, { "Mard色号": "F8", "映射颜色": "#D96D61" }, { "Mard色号": "F9", "映射颜色": "#D25447" }, { "Mard色号": "F10", "映射颜色": "#CB3A2D" }, { "Mard色号": "F11", "映射颜色": "#C42113" }, { "Mard色号": "F12", "映射颜色": "#BB0800" }, { "Mard色号": "F13", "映射颜色": "#B30000" }, { "Mard色号": "F14", "映射颜色": "#DD9C8F" }, { "Mard色号": "F15", "映射颜色": "#D78577" }, { "Mard色号": "F16", "映射颜色": "#D16F5F" }, { "Mard色号": "F17", "映射颜色": "#CB5847" }, { "Mard色号": "F18", "映射颜色": "#C5422F" }, { "Mard色号": "F19", "映射颜色": "#BE2B17" }, { "Mard色号": "F20", "映射颜色": "#E5BDB2" }, { "Mard色号": "F21", "映射颜色": "#DEAB9E" }, { "Mard色号": "F22", "映射颜色": "#D79A8B" }, { "Mard色号": "F23", "映射颜色": "#D08877" }, { "Mard色号": "F24", "映射颜色": "#CA7764" }, { "Mard色号": "F25", "映射颜色": "#C36550" }, { "Mard色号": "G1", "映射颜色": "#E8D5C1" }, { "Mard色号": "G2", "映射颜色": "#E3CBAD" }, { "Mard色号": "G3", "映射颜色": "#DEC199" }, { "Mard色号": "G4", "映射颜色": "#D8B785" }, { "Mard色号": "G5", "映射颜色": "#D2AD71" }, { "Mard色号": "G6", "映射颜色": "#CCA35D" }, { "Mard色号": "G7", "映射颜色": "#B69777" }, { "Mard色号": "G8", "映射颜色": "#AD8A65" }, { "Mard色号": "G9", "映射颜色": "#A47E53" }, { "Mard色号": "G10", "映射颜色": "#9B7141" }, { "Mard色号": "G11", "映射颜色": "#92652F" }, { "Mard色号": "G12", "映射颜色": "#89581D" }, { "Mard色号": "G13", "映射颜色": "#CBAE8D" }, { "Mard色号": "G14", "映射颜色": "#C3A17B" }, { "Mard色号": "G15", "映射颜色": "#BC9569" }, { "Mard色号": "G16", "映射颜色": "#B48857" }, { "Mard色号": "G17", "映射颜色": "#AC7C45" }, { "Mard色号": "G18", "映射颜色": "#A47033" }, { "Mard色号": "G19", "映射颜色": "#C39A77" }, { "Mard色号": "G20", "映射颜色": "#BA8C65" }, { "Mard色号": "G21", "映射颜色": "#B17F53" }, { "Mard色号": "H1", "映射颜色": "#FFFFFF" }, { "Mard色号": "H2", "映射颜色": "#FFFFFF" }, { "Mard色号": "H3", "映射颜色": "#FFFFFF" }, { "Mard色号": "H4", "映射颜色": "#3B3B3B" }, { "Mard色号": "H5", "映射颜色": "#4D4D4D" }, { "Mard色号": "H6", "映射颜色": "#5F5F5F" }, { "Mard色号": "H7", "映射颜色": "#717171" }, { "Mard色号": "H8", "映射颜色": "#838383" }, { "Mard色号": "H9", "映射颜色": "#959595" }, { "Mard色号": "H10", "映射颜色": "#A7A7A7" }, { "Mard色号": "H11", "映射颜色": "#B9B9B9" }, { "Mard色号": "H12", "映射颜色": "#CBCBCB" }, { "Mard色号": "H13", "映射颜色": "#DCDCDC" }, { "Mard色号": "H14", "映射颜色": "#EDEDED" }, { "Mard色号": "H15", "映射颜色": "#FFFFFF" }, { "Mard色号": "H16", "映射颜色": "#696760" }, { "Mard色号": "H17", "映射颜色": "#7A7870" }, { "Mard色号": "H18", "映射颜色": "#8C8A80" }, { "Mard色号": "H19", "映射颜色": "#9D9B90" }, { "Mard色号": "H20", "映射颜色": "#AEACA0" }, { "Mard色号": "H21", "映射颜色": "#BFBDB0" }, { "Mard色号": "H22", "映射颜色": "#D1CEC0" }, { "Mard色号": "H23", "映射颜色": "#E2DFD0" }, { "Mard色号": "M1", "映射颜色": "#DED8D0" }, { "Mard色号": "M2", "映射颜色": "#D6CEC6" }, { "Mard色号": "M3", "映射颜色": "#CECAC1" }, { "Mard色号": "M4", "映射颜色": "#C6C5BC" }, { "Mard色号": "M5", "映射颜色": "#C4BFB3" }, { "Mard色号": "M6", "映射颜色": "#BDB8AB" }, { "Mard色号": "M7", "映射颜色": "#B6B1A3" }, { "Mard色号": "M8", "映射颜色": "#AFA99B" }, { "Mard色号": "M9", "映射颜色": "#A8A293" }, { "Mard色号": "M10", "映射颜色": "#A19B8B" }, { "Mard色号": "M11", "映射颜色": "#9A9180" }, { "Mard色号": "M12", "映射颜色": "#938775" }, { "Mard色号": "M13", "映射颜色": "#8C7D6A" }, { "Mard色号": "M14", "映射颜色": "#85735F" }, { "Mard色号": "M15", "映射颜色": "#7E6954" } ];
        
        const uploadArea = document.getElementById('uploadArea'); const fileInput = document.getElementById('fileInput'); const convertBtn = document.getElementById('convertBtn'); const pixelOptions = document.getElementById('pixelOptions'); const colorOptions = document.getElementById('colorOptions'); const pixelCanvas = document.getElementById('pixelCanvas'); const placeholder = document.getElementById('placeholder'); const colorPalette = document.getElementById('colorPalette'); const colorList = document.getElementById('colorList'); const colorTooltip = document.getElementById('colorTooltip'); const highlightCanvas = document.getElementById('highlightCanvas'); const canvasWrapper = document.querySelector('.canvas-wrapper');
        const actionButtons = document.getElementById('actionButtons'); const downloadBtn = document.getElementById('downloadBtn'); const zoomBtn = document.getElementById('zoomBtn'); const zoomModal = document.getElementById('zoomModal'); const closeZoomBtn = document.getElementById('closeZoomBtn'); const zoomedImage = document.getElementById('zoomedImage');
        let originalImage = null; let selectedPixelSize = 20; let selectedColorCount = 10;
        
        function handleOptionClick(event, optionType) { const container = event.currentTarget; const target = event.target.closest('.option-btn'); if (target && !target.classList.contains('active')) { container.querySelector('.active').classList.remove('active'); target.classList.add('active'); if (optionType === 'pixel') { selectedPixelSize = parseInt(target.dataset.value, 10); } else if (optionType === 'color') { selectedColorCount = parseInt(target.dataset.value, 10); } } }
        pixelOptions.addEventListener('click', (e) => handleOptionClick(e, 'pixel'));
        colorOptions.addEventListener('click', (e) => handleOptionClick(e, 'color'));
        
        function processFile(file) { if (file && file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (e) => { originalImage = new Image(); originalImage.onload = () => { uploadArea.innerHTML = ''; const previewImg = document.createElement('img'); previewImg.src = e.target.result; previewImg.classList.add('preview-image'); uploadArea.appendChild(previewImg); convertBtn.disabled = false; convertBtn.textContent = '开始转换'; }; originalImage.src = e.target.result; }; reader.readAsDataURL(file); } else { alert('请上传有效的图片文件 (JPG, PNG, GIF等)'); } }
        
        // ▼ 修复：重新添加被误删的上传事件监听器 ▼
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                processFile(event.target.files[0]);
            }
        });
        ['dragover', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }));
        uploadArea.addEventListener('dragover', () => uploadArea.classList.add('drag-over'));
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
        uploadArea.addEventListener('drop', (event) => {
            uploadArea.classList.remove('drag-over');
            if (event.dataTransfer.files.length > 0) {
                processFile(event.dataTransfer.files[0]);
            }
        });

        convertBtn.addEventListener('click', () => { if (!originalImage) { alert('请先上传一张图片！'); return; } convertBtn.disabled = true; convertBtn.textContent = "转换中..."; setTimeout(() => { pixelateImage(originalImage, selectedPixelSize, selectedColorCount); convertBtn.disabled = false; convertBtn.textContent = "重新转换"; }, 10); });
        
        // ... 此处省略了 K-Means 和其他所有未改动的函数，以保持简洁 ...
        function hexToRgb(hex) { const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null; }
        const mardRgbColors = mardColors.map(c => ({ ...c, rgb: hexToRgb(c['映射颜色']) }));
        function colorDistance(rgb1, rgb2) { let r_diff = rgb1.r - rgb2.r; let g_diff = rgb1.g - rgb2.g; let b_diff = rgb1.b - rgb2.b; return (r_diff * r_diff * 3) + (g_diff * g_diff * 4) + (b_diff * b_diff * 2); }
        let nearestColorCache = {}; function findNearestMardColor(r, g, b) { const cacheKey = `${r},${g},${b}`; if(nearestColorCache[cacheKey]) return nearestColorCache[cacheKey]; let minDistance = Infinity; let nearestColor = null; for (const mardColor of mardRgbColors) { if (!mardColor.rgb) continue; const distance = colorDistance({ r, g, b }, mardColor.rgb); if (distance < minDistance) { minDistance = distance; nearestColor = mardColor; } } nearestColorCache[cacheKey] = nearestColor; return nearestColor; }
        function kMeans(pixels, k) { let centroids = []; for (let i = 0; i < k; i++) { centroids.push(pixels[Math.floor(Math.random() * pixels.length)]); } for (let iter = 0; iter < 20; iter++) { let clusters = Array.from({ length: k }, () => []); for (const pixel of pixels) { let minD = Infinity; let clusterIndex = 0; for (let i = 0; i < k; i++) { const d = colorDistance(pixel, centroids[i]); if (d < minD) { minD = d; clusterIndex = i; } } clusters[clusterIndex].push(pixel); } let converged = true; for (let i = 0; i < k; i++) { if (clusters[i].length === 0) { centroids[i] = pixels[Math.floor(Math.random() * pixels.length)]; continue; } const sum = clusters[i].reduce((acc, p) => ({ r: acc.r + p.r, g: acc.g + p.g, b: acc.b + p.b }), { r: 0, g: 0, b: 0 }); const newCentroid = { r: Math.round(sum.r / clusters[i].length), g: Math.round(sum.g / clusters[i].length), b: Math.round(sum.b / clusters[i].length) }; if(colorDistance(newCentroid, centroids[i]) > 1) converged = false; centroids[i] = newCentroid; } if (converged) break; } return centroids; }
        let pixelData = []; async function pixelateImage(img, pixelSize, colorCount) { placeholder.classList.add('hidden'); pixelCanvas.classList.remove('hidden'); highlightCanvas.classList.remove('hidden'); const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true }); const aspectRatio = img.width / img.height; const targetWidth = pixelSize; const targetHeight = Math.round(pixelSize / aspectRatio); tempCanvas.width = targetWidth; tempCanvas.height = targetHeight; tempCtx.drawImage(img, 0, 0, targetWidth, targetHeight); const imageData = tempCtx.getImageData(0, 0, targetWidth, targetHeight); const data = imageData.data; let originalPixels = []; for (let i = 0; i < data.length; i += 4) { originalPixels.push({ r: data[i], g: data[i+1], b: data[i+2] }); } const dominantColors = kMeans(originalPixels, colorCount); const finalPalette = new Map(); const usedMardColors = new Map(); nearestColorCache = {}; for (const color of dominantColors) { const nearestMard = findNearestMardColor(color.r, color.g, color.b); finalPalette.set(color, nearestMard); if (!usedMardColors.has(nearestMard['Mard色号'])) { usedMardColors.set(nearestMard['Mard色号'], { count: 0, color: nearestMard }); } } pixelData = []; for (let y = 0; y < targetHeight; y++) { let row = []; for (let x = 0; x < targetWidth; x++) { const originalPixel = originalPixels[y * targetWidth + x]; let minD = Infinity; let bestDominantColor = dominantColors[0]; for (const dominant of dominantColors) { const d = colorDistance(originalPixel, dominant); if (d < minD) { minD = d; bestDominantColor = dominant; } } const finalColor = finalPalette.get(bestDominantColor); row.push(finalColor); usedMardColors.get(finalColor['Mard色号']).count++; } pixelData.push(row); } drawPixelatedImage(targetWidth, targetHeight); updateColorPalette(usedMardColors); actionButtons.classList.remove('hidden'); }
        function drawPixelatedImage(width, height) { const container = document.querySelector('.canvas-container'); const containerSize = Math.min(container.clientWidth, container.clientHeight, 500); let pixelDrawSize; if (width > height) { pixelDrawSize = Math.floor(containerSize / width); } else { pixelDrawSize = Math.floor(containerSize / height); } const canvasWidth = width * pixelDrawSize; const canvasHeight = height * pixelDrawSize; canvasWrapper.style.width = `${canvasWidth}px`; canvasWrapper.style.height = `${canvasHeight}px`; pixelCanvas.width = canvasWidth; pixelCanvas.height = canvasHeight; highlightCanvas.width = canvasWidth; highlightCanvas.height = canvasHeight; const ctx = pixelCanvas.getContext('2d'); ctx.clearRect(0, 0, pixelCanvas.width, pixelCanvas.height); for(let y = 0; y < height; y++) { for(let x = 0; x < width; x++) { ctx.fillStyle = pixelData[y][x]['映射颜色']; ctx.fillRect(x * pixelDrawSize, y * pixelDrawSize, pixelDrawSize, pixelDrawSize); } } }
        function updateColorPalette(usedColors) { colorList.innerHTML = ''; const sortedColors = Array.from(usedColors.values()).filter(c => c.count > 0).sort((a, b) => b.count - a.count); sortedColors.forEach(item => { const colorItem = document.createElement('div'); colorItem.className = 'color-item'; colorItem.dataset.mardCode = item.color['Mard色号']; const swatch = document.createElement('div'); swatch.className = 'color-swatch'; swatch.style.backgroundColor = item.color['映射颜色']; const code = document.createElement('div'); code.className = 'color-code'; code.textContent = item.color['Mard色号']; colorItem.appendChild(swatch); colorItem.appendChild(code); colorList.appendChild(colorItem); }); colorPalette.classList.remove('hidden'); }
        pixelCanvas.addEventListener('mousemove', (e) => { if (!pixelData.length) return; const rect = pixelCanvas.getBoundingClientRect(); const scaleX = pixelCanvas.width / rect.width; const scaleY = pixelCanvas.height / rect.height; const canvasX = (e.clientX - rect.left) * scaleX; const canvasY = (e.clientY - rect.top) * scaleY; const pixelDrawSize = pixelCanvas.width / pixelData[0].length; const x = Math.floor(canvasX / pixelDrawSize); const y = Math.floor(canvasY / pixelDrawSize); if (pixelData[y] && pixelData[y][x]) { const colorInfo = pixelData[y][x]; colorTooltip.textContent = `${colorInfo['Mard色号']} - ${colorInfo['映射颜色']}`; colorTooltip.style.left = `${e.clientX}px`; colorTooltip.style.top = `${e.clientY}px`; colorTooltip.classList.add('show'); highlightPaletteColor(colorInfo['Mard色号']); drawHighlight(colorInfo['Mard色号']); } });
        pixelCanvas.addEventListener('mouseleave', () => { colorTooltip.classList.remove('show'); clearPaletteHighlight(); const highlightCtx = highlightCanvas.getContext('2d'); highlightCtx.clearRect(0, 0, highlightCanvas.width, highlightCanvas.height); });
        function drawHighlight(targetMardCode) { const highlightCtx = highlightCanvas.getContext('2d'); const pixelDrawSize = pixelCanvas.width / pixelData[0].length; highlightCtx.clearRect(0, 0, highlightCanvas.width, highlightCanvas.height); highlightCtx.strokeStyle = 'rgba(255, 255, 255, 0.9)'; highlightCtx.lineWidth = Math.max(2, pixelDrawSize * 0.1); for (let y = 0; y < pixelData.length; y++) { for (let x = 0; x < pixelData[y].length; x++) { if (pixelData[y][x]['Mard色号'] === targetMardCode) { highlightCtx.strokeRect(x * pixelDrawSize + highlightCtx.lineWidth / 2, y * pixelDrawSize + highlightCtx.lineWidth / 2, pixelDrawSize - highlightCtx.lineWidth, pixelDrawSize - highlightCtx.lineWidth); } } } }
        colorList.addEventListener('mouseover', (e) => { const item = e.target.closest('.color-item'); if(item) { highlightPaletteColor(item.dataset.mardCode); drawHighlight(item.dataset.mardCode); } }); colorList.addEventListener('mouseout', () => { clearPaletteHighlight(); const highlightCtx = highlightCanvas.getContext('2d'); highlightCtx.clearRect(0, 0, highlightCanvas.width, highlightCanvas.height); });
        function highlightPaletteColor(mardCode) { const items = colorList.querySelectorAll('.color-item'); items.forEach(item => { item.classList.toggle('highlighted', item.dataset.mardCode === mardCode); item.classList.toggle('dimmed', item.dataset.mardCode !== mardCode); }); }
        function clearPaletteHighlight() { const items = colorList.querySelectorAll('.color-item'); items.forEach(item => item.classList.remove('highlighted', 'dimmed')); }
        downloadBtn.addEventListener('click', () => { const link = document.createElement('a'); link.download = 'pixel-art.png'; link.href = pixelCanvas.toDataURL('image/png'); link.click(); });
        zoomBtn.addEventListener('click', () => { zoomedImage.src = pixelCanvas.toDataURL('image/png'); zoomModal.classList.remove('hidden'); });
        closeZoomBtn.addEventListener('click', () => zoomModal.classList.add('hidden'));
        zoomModal.addEventListener('click', (e) => { if (e.target === zoomModal) { zoomModal.classList.add('hidden'); } });
    </script>
</body>
</html>
